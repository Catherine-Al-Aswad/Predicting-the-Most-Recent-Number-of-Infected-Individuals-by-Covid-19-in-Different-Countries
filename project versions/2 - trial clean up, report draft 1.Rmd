---
title: "Effect of Government Response on the Number of Infected Individuals"
author: "Catherine Al Aswad, Ali Alhakeem, Uyen Dao, Long Kim Long"
date: " Last Updated 11/11/2020"
output:
  html_document:
    fig_caption: yes
    theme: lumen
    toc: yes
    toc_depth: 2
    df_print: kable
    toc_float:
      collapsed: no
---

```{r, include=FALSE}
# Do not edit this code block/chunk
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE, fig.width = 16/2.5, fig.height = 9/2.5)
```


```{r Packages}
# Load all necessary packages here:
library(tidyverse) 
library(janitor)
library(moderndive)
library(here)
library(knitr)
library(readxl)
library(tibbletime)    #to sort a variable of type 'date'
library(MASS)    #for box-cox
library(car)    #for vif and qqplot()
library(plotly)   # for interactive graphs
library(olsrr)   # cook's distance
library(GGally)    # ggpairs()
library(corrplot)   #fancy correlation matrix
library(splines)


```

```{r Wrangling}
# data wrangling code:
#reading in the code
confirmed_cases <- read_csv(here("time_series_covid19_confirmed_global_2.csv"))
indicator_data <- read_csv(here("indicator data 2.csv"))
total_population <- read_xls(here("total_population.xls"))

age_population_prop <- read_xls(here("age_group_population_proportion.xls"))
percent_out_of_pocket_exp <- read_xls(here("percent_out_of_pocket_exp.xls"))
smoking_prevalence_males <- read_xls(here("smoking_prevalence_males.xls"))




## confirmed cases data set
# selecting the columns we need
# pivoting the table to tidy it
confirmed_cases_tidy <- confirmed_cases %>%
    dplyr::select(-c("Province/State", "Lat", "Long")) %>%
    pivot_longer(names_to = "date",    
               values_to = "cumulative_confirmed_cases", 
               cols = -"Country/Region" ) 

# changing column names (doing it early because a name with / without "" causes problems later)
colnames(confirmed_cases_tidy) <- c("Country" , "Date" , "cumulative_confirmed_cases")

# Taking the sum of confirmed cases of all the regions in a country; before, the cases were per region in each country, we are summing them to get total per country, irrelevant of region
# Changed the date and country type, so that it is not hard to join them later
# filter the data for the date we want: 2020-10-23, the earliest day for doing the study (known before starting the analysis)
confirmed_cases_tidy <- confirmed_cases_tidy %>%
    group_by(Country, Date) %>%
    summarise(cumulative_confirmed_cases = sum(cumulative_confirmed_cases)) %>%    
    mutate(Date = as.Date(Date, format = "%m/%d/%y"),
           Country = as.factor(Country)) %>%
    arrange(Date) %>%
    as_tbl_time(index = Date) %>%
    filter_time(time_formula = ~ '2020-10-23')   

# Some countries are referred to differently in each data set, so we fixed their names to be consistent, so some country data is not lost. The countries whose alternative names are not obvious where searched to make sure that they are correct. 
# The code commented out below was used to check for inconsistent country names:
# setdiff(unique(total_population_tidy$Country),unique(indicator_data_tidy$Country))
# setdiff(unique(indicator_data_tidy$Country),unique(total_population_tidy$Country))
# 
# setdiff(unique(total_population_tidy$Country),unique(confirmed_cases_tidy$Country))
# setdiff(unique(confirmed_cases_tidy$Country),unique(total_population_tidy$Country))
# 
# setdiff(unique(indicator_data_tidy$Country), unique(confirmed_cases_tidy$Country))
# setdiff(unique(confirmed_cases_tidy$Country), unique(indicator_data_tidy$Country))

levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="US"] = "United States"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Taiwan*"] = "Taiwan"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Burma"] = "Myanmar"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Korea, South"] = "Republic of Korea (South)"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Slovakia"] = "Slovak Republic"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Czechia"] = "Czech Republic"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Congo (Brazzaville)"] = "The Republic of Congo"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Congo (Kinshasa)"] = "The Democratic Republic of Congo"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Kyrgyzstan"] = "Kyrgyz Republic"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Iran"] = "Islamic Republic of Iran"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Syria"] = "Syrian Arab Republic"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Russia"] = "Russian Federation"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Egypt"] = "Arab Republic of Egypt"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Yemen"] = "Republic of Yemen"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Venezuela"] = "Venezuela, RB"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Brunei"] = "Brunei Darussalam"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Laos"] = "Lao People's Democratic Republic"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Saint Kitts and Nevis"] = "St. Kitts and Nevis"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Saint Vincent and the Grenadines"] = "St. Vincent and the Grenadines"
levels(confirmed_cases_tidy$Country)[levels(confirmed_cases_tidy$Country)=="Saint Lucia"] = "St. Lucia"




## indicator data set
# removed the first row which are the column titles
# selected the columns we want ( we knew in advance which indices we will use)
# changed the date and country type to facilitate joining them later
# took the average index for a country (we have regional indices, but we want it for the entire country)
# filtered the data for the date we want (known before starting the analysis)
indicator_data_tidy <- indicator_data[-1,] %>%
   dplyr::select("CountryName", "Date", "StringencyIndex", "EconomicSupportIndex") %>%
   mutate(Date = as.Date(Date, format = "%Y%m%d"),
          CountryName = as.factor(CountryName)) %>%
   group_by(CountryName, Date) %>%
   summarise(StringencyIndex = mean(StringencyIndex, na.rm=TRUE),
             EconomicSupportIndex = mean(EconomicSupportIndex, na.rm = TRUE)) %>%
   arrange(Date) %>%
   as_tbl_time(index = Date) %>%
   filter_time(time_formula = ~ '2020-06-15')   

# Changed the column names
colnames(indicator_data_tidy) <- c("Country" , "Date" ,  "Stringency_Index", "Economic_Support_Index")

# Some countries are referred to differently in each data set, so we fixed their names to be consistent, so some country data is not lost. The countries whose alternative names are not obvious where searched to make sure that they are correct. 
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Cape Verde"] = "Cabo Verde"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Palestine"] = "West Bank and Gaza"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Congo"] = "The Republic of Congo"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Democratic Republic of Congo"] =  "The Democratic Republic of Congo"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Iran"] = "Islamic Republic of Iran"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Syria"] = "Syrian Arab Republic"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Hong Kong"] = "Hong Kong SAR, China"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Russia"] = "Russian Federation"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="South Korea"] = "Republic of Korea (South)"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Egypt"] = "Arab Republic of Egypt"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Yemen"] = "Republic of Yemen"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Venezuela"] = "Venezuela, RB"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Brunei"] = "Brunei Darussalam"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Laos"] = "Lao People's Democratic Republic"
levels(indicator_data_tidy$Country)[levels(indicator_data_tidy$Country)=="Macao"] = "Macao SAR, China"



#population data set
# removed first 3 rows: an entirely empty row, the title row, and a row not about a country
# selected the columns we want: using 2019 population (...64) because 2020 population (...65) is not available  
# there is a line for 'Not classified' data source and is the only one with an na population in 2019; removed it
# fixed data types
total_population_tidy <- total_population[-c(1:3),] %>%  
  dplyr::select("Data Source", "...64") %>% 
  na.omit() %>%  
  mutate(...64 = as.double(...64))

# changed column names; did this early since a name with a space causes problems in the code if there is no ""
colnames(total_population_tidy) <- c("Country" , "Population2019")

# fixed the country type to the join works
total_population_tidy <- total_population_tidy %>%
  mutate(Country = as.factor(Country))       

# Some countries are referred to differently in each data set, so we fixed their names to be consistent, so some country data is not lost. The countries whose alternative names are not obvious where searched to make sure that they are correct. 
levels(total_population_tidy$Country)[levels(total_population_tidy$Country)== "Virgin Islands (U.S.)"] = "United States Virgin Islands"
levels(total_population_tidy$Country)[levels(total_population_tidy$Country)=="Congo, Rep."] = "The Republic of Congo"
levels(total_population_tidy$Country)[levels(total_population_tidy$Country)=="Congo, Dem. Rep."] =  "The Democratic Republic of Congo"
levels(total_population_tidy$Country)[levels(total_population_tidy$Country)=="Iran, Islamic Rep."] = "Islamic Republic of Iran"
levels(total_population_tidy$Country)[levels(total_population_tidy$Country)=="Korea, Rep."] = "Republic of Korea (South)"
levels(total_population_tidy$Country)[levels(total_population_tidy$Country)=="Egypt, Arab Rep."] = "Arab Republic of Egypt"
levels(total_population_tidy$Country)[levels(total_population_tidy$Country)=="Yemen, Rep."] = "Republic of Yemen"
levels(total_population_tidy$Country)[levels(total_population_tidy$Country)=="Gambia, The"] = "Gambia"
levels(total_population_tidy$Country)[levels(total_population_tidy$Country)=="Lao PDR"] = "Lao People's Democratic Republic"
levels(total_population_tidy$Country)[levels(total_population_tidy$Country)=="Bahamas, The"] = "Bahamas"





## age_population_prop data set:   			Population ages 15-64 (% of total population)
age_population_prop_tidy <- age_population_prop[-c(1:3),] %>% 
  dplyr::select("Data Source", "...64") %>% 
  na.omit() %>%  
  mutate(...64 = as.double(...64))

# changed column names; did this early since a name with a space causes problems in the code if there is no ""
colnames(age_population_prop_tidy) <- c("Country" , "age15_64_population_prop_2019")

# fixed the country type to the join works
age_population_prop_tidy <- age_population_prop_tidy %>%
  mutate(Country = as.factor(Country)) 

levels(age_population_prop_tidy$Country)[levels(age_population_prop_tidy$Country)== "Virgin Islands (U.S.)"] = "United States Virgin Islands"
levels(age_population_prop_tidy$Country)[levels(age_population_prop_tidy$Country)=="Congo, Rep."] = "The Republic of Congo"
levels(age_population_prop_tidy$Country)[levels(age_population_prop_tidy$Country)=="Congo, Dem. Rep."] =  "The Democratic Republic of Congo"
levels(age_population_prop_tidy$Country)[levels(age_population_prop_tidy$Country)=="Iran, Islamic Rep."] = "Islamic Republic of Iran"
levels(age_population_prop_tidy$Country)[levels(age_population_prop_tidy$Country)=="Korea, Rep."] = "Republic of Korea (South)"
levels(age_population_prop_tidy$Country)[levels(age_population_prop_tidy$Country)=="Egypt, Arab Rep."] = "Arab Republic of Egypt"
levels(age_population_prop_tidy$Country)[levels(age_population_prop_tidy$Country)=="Yemen, Rep."] = "Republic of Yemen"
levels(age_population_prop_tidy$Country)[levels(age_population_prop_tidy$Country)=="Gambia, The"] = "Gambia"
levels(age_population_prop_tidy$Country)[levels(age_population_prop_tidy$Country)=="Lao PDR"] = "Lao People's Democratic Republic"
levels(age_population_prop_tidy$Country)[levels(age_population_prop_tidy$Country)=="Bahamas, The"] = "Bahamas"





## percent_out_of_pocket_exp data set:   					Out-of-pocket expenditure (% of current health expenditure)
percent_out_of_pocket_exp_tidy <- percent_out_of_pocket_exp[-c(1:3),] %>% 
  dplyr::select("Data Source", "...62") %>% 
  na.omit() %>%  
  mutate(...62 = as.double(...62))

# changed column names; did this early since a name with a space causes problems in the code if there is no ""
colnames(percent_out_of_pocket_exp_tidy) <- c("Country" , "out_of_pocket_expenditures_2017")

# fixed the country type to the join works
percent_out_of_pocket_exp_tidy <- percent_out_of_pocket_exp_tidy %>%
  mutate(Country = as.factor(Country)) 

levels(percent_out_of_pocket_exp_tidy$Country)[levels(percent_out_of_pocket_exp_tidy$Country)== "Virgin Islands (U.S.)"] = "United States Virgin Islands"
levels(percent_out_of_pocket_exp_tidy$Country)[levels(percent_out_of_pocket_exp_tidy$Country)=="Congo, Rep."] = "The Republic of Congo"
levels(percent_out_of_pocket_exp_tidy$Country)[levels(percent_out_of_pocket_exp_tidy$Country)=="Congo, Dem. Rep."] =  "The Democratic Republic of Congo"
levels(percent_out_of_pocket_exp_tidy$Country)[levels(percent_out_of_pocket_exp_tidy$Country)=="Iran, Islamic Rep."] = "Islamic Republic of Iran"
levels(percent_out_of_pocket_exp_tidy$Country)[levels(percent_out_of_pocket_exp_tidy$Country)=="Korea, Rep."] = "Republic of Korea (South)"
levels(percent_out_of_pocket_exp_tidy$Country)[levels(percent_out_of_pocket_exp_tidy$Country)=="Egypt, Arab Rep."] = "Arab Republic of Egypt"
levels(percent_out_of_pocket_exp_tidy$Country)[levels(percent_out_of_pocket_exp_tidy$Country)=="Yemen, Rep."] = "Republic of Yemen"
levels(percent_out_of_pocket_exp_tidy$Country)[levels(percent_out_of_pocket_exp_tidy$Country)=="Gambia, The"] = "Gambia"
levels(percent_out_of_pocket_exp_tidy$Country)[levels(percent_out_of_pocket_exp_tidy$Country)=="Lao PDR"] = "Lao People's Democratic Republic"
levels(percent_out_of_pocket_exp_tidy$Country)[levels(percent_out_of_pocket_exp_tidy$Country)=="Bahamas, The"] = "Bahamas"



## smoking_prevalence_males data set:   				Smoking prevalence for males, total 
smoking_prevalence_males_tidy <- smoking_prevalence_males[-c(1:3),] %>% 
  dplyr::select("Data Source", "...61") %>% 
  na.omit() %>%  
  mutate(...61 = as.double(...61))

# changed column names; did this early since a name with a space causes problems in the code if there is no ""
colnames(smoking_prevalence_males_tidy) <- c("Country" , "Smoking_prevalence_males_2016")

# fixed the country type to the join works
smoking_prevalence_males_tidy <- smoking_prevalence_males_tidy %>%
  mutate(Country = as.factor(Country)) 


levels(smoking_prevalence_males_tidy$Country)[levels(smoking_prevalence_males_tidy$Country)== "Virgin Islands (U.S.)"] = "United States Virgin Islands"
levels(smoking_prevalence_males_tidy$Country)[levels(smoking_prevalence_males_tidy$Country)=="Congo, Rep."] = "The Republic of Congo"
levels(smoking_prevalence_males_tidy$Country)[levels(smoking_prevalence_males_tidy$Country)=="Congo, Dem. Rep."] =  "The Democratic Republic of Congo"
levels(smoking_prevalence_males_tidy$Country)[levels(smoking_prevalence_males_tidy$Country)=="Iran, Islamic Rep."] = "Islamic Republic of Iran"
levels(smoking_prevalence_males_tidy$Country)[levels(smoking_prevalence_males_tidy$Country)=="Korea, Rep."] = "Republic of Korea (South)"
levels(smoking_prevalence_males_tidy$Country)[levels(smoking_prevalence_males_tidy$Country)=="Egypt, Arab Rep."] = "Arab Republic of Egypt"
levels(smoking_prevalence_males_tidy$Country)[levels(smoking_prevalence_males_tidy$Country)=="Yemen, Rep."] = "Republic of Yemen"
levels(smoking_prevalence_males_tidy$Country)[levels(smoking_prevalence_males_tidy$Country)=="Gambia, The"] = "Gambia"
levels(smoking_prevalence_males_tidy$Country)[levels(smoking_prevalence_males_tidy$Country)=="Lao PDR"] = "Lao People's Democratic Republic"
levels(smoking_prevalence_males_tidy$Country)[levels(smoking_prevalence_males_tidy$Country)=="Bahamas, The"] = "Bahamas"


# setdiff(unique(diabetes_prevelance_tidy$Country),unique(indicator_data_tidy$Country))
# setdiff(unique(indicator_data_tidy$Country),unique(water_sanitation_access_tidy$Country))
# 
# setdiff(unique(diabetes_prevelance_tidy$Country),unique(confirmed_cases_tidy$Country))
# setdiff(unique(confirmed_cases_tidy$Country),unique(water_sanitation_access_tidy$Country))
# 
# setdiff(unique(diabetes_prevelance_tidy$Country), unique(total_population_tidy$Country))
# setdiff(unique(total_population_tidy$Country), unique(water_sanitation_access_tidy$Country))

 


## final joint data set
# did the join by country
# created our dependent variable (there is no population of zero when dividing, and neither variable used has missing values)
# removed missing values (only the indices had missing values)
 tidy_joined_dataset <-  indicator_data_tidy %>%
    inner_join(confirmed_cases_tidy, by = c ("Country")) %>%
    inner_join(total_population_tidy, by = c ("Country")) %>%
    inner_join(age_population_prop_tidy, by = c ("Country")) %>%
    inner_join(percent_out_of_pocket_exp_tidy, by = c ("Country")) %>%
     inner_join(smoking_prevalence_males_tidy, by = c ("Country")) %>%      # meh
    mutate(cumulative_confirmed_cases_per_10000 = (cumulative_confirmed_cases/Population2019)*10000,
           Economic_Support_Index_levels = cut(Economic_Support_Index, 
                                               breaks = c(0,12.5,25, 37.5, 50,62.5, 75,87.5, 100, Inf),
                                               labels = c("[0,12.5)", "[12.5,25)","[25,37.5)", "[37.5,50)", "[50,62.5)", "[62.5, 75)", "[75,87.5)", "[87.5, 100)", "100"),
                                               right  = FALSE))   %>%
    na.omit()  
 


```


***


# I. Introduction 


Table 1.Sample for 5 randomly chosen countries of the data set used in this study
```{r sample_table}

Cases_filtered = tidy_joined_dataset %>%
  dplyr::select(c(Country, Stringency_Index, Economic_Support_Index, Population2019, cumulative_confirmed_cases_per_10000, age15_64_population_prop_2019, out_of_pocket_expenditures_2017, Smoking_prevalence_males_2016, Economic_Support_Index_levels ))


sample <- Cases_filtered %>% 
  ungroup() %>%
  sample_n(5)

sample %>%
    dplyr::select(c(Country, cumulative_confirmed_cases_per_10000, Stringency_Index, Economic_Support_Index, Economic_Support_Index_levels))


sample %>%
    dplyr::select(c(Country, Population2019, age15_64_population_prop_2019, out_of_pocket_expenditures_2017, Smoking_prevalence_males_2016 ))



```



***


# II. Exploratory data analysis


***
Table 2: Summary for the cumulative confirmed cases per 10,000
```{r summary_table}
tidy_joined_dataset %>% 
  ungroup() %>%
  summarize(n = n(), 
            min = min(cumulative_confirmed_cases_per_10000 , na.rm = T), 
            median = median(cumulative_confirmed_cases_per_10000 , na.rm = T), 
            mean = mean(cumulative_confirmed_cases_per_10000 , na.rm = T), 
            max = max(cumulative_confirmed_cases_per_10000 , na.rm = T),
            sd = sd(cumulative_confirmed_cases_per_10000 , na.rm = T)) 

```


```{r   D_CCPTTH, fig.cap = "Figure 1. Distribution for the cumulative confirmed cases per 10,000 for individual countries ", fig.align = "center"}

ggplot(tidy_joined_dataset,  aes(x= cumulative_confirmed_cases_per_10000)) +
  geom_histogram(bins = 20, fill = "#f9f906", color = "#ff6600") +
  labs(x = "Cumulative confirmed cases per 10,000 individuals") +
    theme_bw()


```



```{r   D_SI, fig.cap = "Figure 2. Distribution for the government response measured by the Stringency Index", fig.align = "center"}

#bimodal, is this normally distributed
ggplot(tidy_joined_dataset, aes(x= Stringency_Index)) +
  geom_histogram(bins = 15, fill = "#f9f906", color = "#ff6600") +
    labs(x = "Stringency Index") +
    theme_bw()


```

```{r   D_ESI, fig.cap = "Figure 3. Distribution for the government response measured by the Economic Support Index", fig.align = "center"}

ggplot(tidy_joined_dataset, aes(x= Economic_Support_Index)) +
  geom_histogram(fill = "#f9f906", color = "#ff6600") +
  labs(x = "Economic Support Index") +
    theme_bw()



```

```{r   D_APP, fig.cap = "Figure 4. Distribution for the Proportion of population that is 15-64 years old, in 2019 for individual countries ", fig.align = "center"}

ggplot(tidy_joined_dataset,  aes(x= age15_64_population_prop_2019)) +
  geom_histogram(bins = 20, fill = "purple", color = "#ff6600") +
  labs(x = "Proportion of population that is 15-64 years old, in 2019") +
    theme_bw()


```


```{r   D_OPE, fig.cap = "Figure 5. Distribution for the Percentage of health expenditures spent out of pocket in 2017 for individual countries ", fig.align = "center"}

ggplot(tidy_joined_dataset,  aes(x= out_of_pocket_expenditures_2017)) +
  geom_histogram(bins = 20, fill = "purple", color = "#ff6600") +
  labs(x = "Percentage of health expenditures spent out of pocket in 2017") +
    theme_bw()


```


```{r   D_SPM, fig.cap = "Figure 6. Distribution for the Smoking prevalence for males in 2016 for individual countries ", fig.align = "center"}

ggplot(tidy_joined_dataset,  aes(x= Smoking_prevalence_males_2016)) +
  geom_histogram(bins = 20, fill = "purple", color = "#ff6600") +
  labs(x = "Smoking prevalence for males in 2016") +
    theme_bw()


```


```{r   SC_SI, fig.cap = "Figure 7.1. Interactive Scatterplot for the cumulative confirmed cases per 10,000 for individual countries against their government response measured by the Stringency Index. The red line is the best fit line. The blue curve is the Loess curve.", fig.align = "center"}

p1 <- ggplot(tidy_joined_dataset, aes(x= Stringency_Index, y= cumulative_confirmed_cases_per_10000, size = Population2019, color = Economic_Support_Index, label = Country )) +
  geom_point(alpha = 0.4) +
  scale_color_gradient(low="#ffff00", high="#ff6600") +
  geom_smooth(method = "lm", se = FALSE, size = 0.4, colour= "red") +
  geom_smooth(method = "loess", se = TRUE, size = 0.4, colour="blue") +
  labs(y = "Cumu. confirmed cases per 10,000", x = "Stringency Index") +
  theme(panel.grid.major =  element_line(colour = "#DCDCDC"),
        panel.grid.minor = element_line(colour = "#DCDCDC"),
        axis.line = element_line(colour = "black"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", 
                                    fill=NA, 
                                    size=0.5))

ggplotly(p1)

```



```{r  SI_SP_ESI, fig.cap = "Figure 7.2. Interactive Scatterplot for the cumulative confirmed cases per 10,000 for individual countries against their government response measured by the Stringency Index, grouped by the Economic Support Index levels", fig.align = "center"}

ggplot(tidy_joined_dataset, aes(x = Stringency_Index, y = cumulative_confirmed_cases_per_10000, size = Population2019, color = Economic_Support_Index_levels, label = Country)) +
  geom_point(alpha = 0.3) +
  scale_color_manual(values = c( "blue" , "mediumvioletred", "pink", "#B34DD8",  "mediumpurple1", "#FFA500", "green", "#FF4500", "#DC143C")) +
  geom_smooth(method = "lm", se = FALSE, size = 0.4) +
  labs(y = "Cumu. confirmed cases per 10,000", x = "Stringency Index") +
  theme_bw()
```

```{r  SI_SP_ESI_S, fig.cap = "Figure 7.3. Interactive Scatterplot for the cumulative confirmed cases per 10,000 for individual countries against their government response measured by the Stringency Index, grouped and divided by the Economic Support Index levels", fig.align = "center"}



ggplot(tidy_joined_dataset, aes(x = Stringency_Index, y = cumulative_confirmed_cases_per_10000, size = Population2019, color = Economic_Support_Index_levels, label = Country)) +
  geom_point(alpha = 0.3) +
  scale_color_manual(values = c( "orange" , "mediumvioletred", "#D56FA9", "#B34DD8",  "mediumpurple1", "#FFA500", "#FF8C00", "#FF4500", "#DC143C")) +
  geom_smooth(method = "lm", se = FALSE, size = 0.4, colour= "red") +
  geom_smooth(method = "loess", se = TRUE, size = 0.4, colour="blue") +  
  labs(y = "Cumu. confirmed cases per 10,000", x = "Stringency Index") +
  theme_bw() +
  facet_wrap(~Economic_Support_Index_levels)



```

```{r SP_ESI , fig.cap = "Figure 8. Interactive Scatterplot for the cumulative confirmed cases per 10,000 for individual countries against their government response measured by the Economic Support Index. The red line is the best fit line. The blue curve is the Loess curve.", fig.align = "center"}

p2 <- ggplot(tidy_joined_dataset, aes(x= Economic_Support_Index, y= cumulative_confirmed_cases_per_10000, size = Population2019, color = Stringency_Index, label = Country)) +
  geom_jitter(alpha = 0.4, width = 1.5, height = 0) +
  scale_color_gradient(low="#ffff00", high="#ff6600") +
  geom_smooth(method = "lm", se = FALSE, size = 0.5, colour= "red") +
  geom_smooth(method = "loess", se = TRUE, size = 0.5, colour="blue") +
  labs(y = "Cumu. confirmed cases per 10,000", x = "Economic Support Index") +
  theme(panel.grid.major =  element_line(colour = "#DCDCDC"),
        panel.grid.minor = element_line(colour = "#DCDCDC"),
        axis.line = element_line(colour = "black"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", 
                                    fill=NA, 
                                    size=0.5))

ggplotly(p2)

```

```{r   SC_APP, fig.cap = "Figure 9. Interactive Scatterplot for the cumulative confirmed cases per 10,000 for individual countries against their Proportion of population that is 15-64 years old, in 2019. The red line is the best fit line. The blue curve is the Loess curve.", fig.align = "center"}

p3_1 <- ggplot(tidy_joined_dataset, aes(x= age15_64_population_prop_2019, y= cumulative_confirmed_cases_per_10000, size = Population2019, color = Stringency_Index, label = Country )) +
  geom_point(alpha = 0.4) +
  scale_color_gradient(low="#ffff00", high="purple") +
  geom_smooth(method = "lm", se = FALSE, size = 0.4, colour= "red") +
  geom_smooth(method = "loess", se = TRUE, size = 0.4, colour="blue") +
  labs(y = "Cumu. confirmed cases per 10,000", x = "Proportion of population that is 15-64 years old, in 2019") +
  theme(panel.grid.major =  element_line(colour = "#DCDCDC"),
        panel.grid.minor = element_line(colour = "#DCDCDC"),
        axis.line = element_line(colour = "black"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black",
                                    fill=NA,
                                    size=0.5))

ggplotly(p3_1)

```

```{r   SC_SPM, fig.cap = "Figure 10. Interactive Scatterplot for the cumulative confirmed cases per 10,000 for individual countries against their Smoking prevalence for males in 2016. The red line is the best fit line. The blue curve is the Loess curve.", fig.align = "center"}



p3_3 <- ggplot(tidy_joined_dataset, aes(x= Smoking_prevalence_males_2016, y= cumulative_confirmed_cases_per_10000, size = Population2019, color = Stringency_Index, label = Country )) +
  geom_point(alpha = 0.4) +
  scale_color_gradient(low="#ffff00", high="purple") +
  geom_smooth(method = "lm", se = FALSE, size = 0.4, colour= "red") +
  geom_smooth(method = "loess", se = TRUE, size = 0.4, colour="blue") +
  labs(y = "Cumu. confirmed cases per 10,000", x = "Smoking prevalence for males in 2016") +
  theme(panel.grid.major =  element_line(colour = "#DCDCDC"),
        panel.grid.minor = element_line(colour = "#DCDCDC"),
        axis.line = element_line(colour = "black"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black",
                                    fill=NA,
                                    size=0.5))

ggplotly(p3_3)

```

```{r   SC_OPE, fig.cap = "Figure 11. Interactive Scatterplot for the cumulative confirmed cases per 10,000 for individual countries against their Percentage of health expenditures spent out of pocket in 2017. The red line is the best fit line. The blue curve is the Loess curve.", fig.align = "center"}


p3_4 <- ggplot(tidy_joined_dataset, aes(x= out_of_pocket_expenditures_2017, y= cumulative_confirmed_cases_per_10000, size = Population2019, color = Stringency_Index, label = Country )) +
  geom_point(alpha = 0.4) +
  scale_color_gradient(low="#ffff00", high="purple") +
  geom_smooth(method = "lm", se = FALSE, size = 0.4, colour= "red") +
  geom_smooth(method = "loess", se = TRUE, size = 0.4, colour="blue") +
  labs(y = "Cumu. confirmed cases per 10,000", x = "Percentage of health expenditures spent out of pocket in 2017") +
  theme(panel.grid.major =  element_line(colour = "#DCDCDC"),
        panel.grid.minor = element_line(colour = "#DCDCDC"),
        axis.line = element_line(colour = "black"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black",
                                    fill=NA,
                                    size=0.5))

ggplotly(p3_4)




```


```{r EI_boxplot_levels, fig.cap = "Figure 12. Boxplot of relationship between  the cumulative confirmed cases per 10,000 for individual countries and the Economic Support Index levels", fig.align = "center"}
ggplot(tidy_joined_dataset, aes(x= Economic_Support_Index_levels, y=cumulative_confirmed_cases_per_10000)) +
  geom_boxplot(fill = c( "orange" , "mediumvioletred", "#D56FA9", "#B34DD8",  "mediumpurple1", "#FFA500", "#FF8C00", "#FF4500", "#DC143C")) +
  labs(y = "Cumu. confirmed cases per 10,000", x = "Economic Support Index levels") +
  theme_bw()

```
Table 3: Correlation matrix for the numeric variables in the study
```{r corr_matrix, fig.align = "center"}


filtered  <- tidy_joined_dataset %>%
   ungroup() %>%
     dplyr::select("cumulative_confirmed_cases_per_10000", "Population2019", "Stringency_Index", "Economic_Support_Index", "age15_64_population_prop_2019" , "out_of_pocket_expenditures_2017", "Smoking_prevalence_males_2016")
 
 # source("http://www.sthda.com/upload/rquery_cormat.r")
 # rquery.cormat(filtered)
# ggpairs(tidy_joined_dataset[,-1])


 corr_mat <- cor(filtered)
  kable(corr_mat, 
        col.names = c('CCCP10000', '2019 Population' , 'SI', 'ESI' ,  '15 to 64 y/o 2019 population proportion' , 'OOPE 2017' , 'SP_M 2016'),
        digits = 3)


  # corrplot(corr_mat)
```


***



# III. Multiple linear regression

## i. Methods


***

```{r  primary_model}

first_model <- lm(cumulative_confirmed_cases_per_10000 ~  Stringency_Index + Economic_Support_Index + age15_64_population_prop_2019 + out_of_pocket_expenditures_2017 + Smoking_prevalence_males_2016 , data = tidy_joined_dataset)

first_model_1 <- lm(cumulative_confirmed_cases_per_10000 ~  Stringency_Index + Economic_Support_Index + poly(age15_64_population_prop_2019,2) + out_of_pocket_expenditures_2017 + Smoking_prevalence_males_2016 , data = tidy_joined_dataset)

first_model_2 <- lm(cumulative_confirmed_cases_per_10000 ~  Stringency_Index + Economic_Support_Index + poly(age15_64_population_prop_2019,3) + out_of_pocket_expenditures_2017 + Smoking_prevalence_males_2016 , data = tidy_joined_dataset)

first_model_3 <- lm(cumulative_confirmed_cases_per_10000 ~  Stringency_Index + Economic_Support_Index_levels + age15_64_population_prop_2019 + out_of_pocket_expenditures_2017 + Smoking_prevalence_males_2016 , data = tidy_joined_dataset)

first_model_4 <- lm(cumulative_confirmed_cases_per_10000 ~  Stringency_Index + Economic_Support_Index_levels + poly(age15_64_population_prop_2019,2) + out_of_pocket_expenditures_2017 + Smoking_prevalence_males_2016 , data = tidy_joined_dataset)




# ols_plot_cooksd_chart(first_model)
# ols_plot_dfbetas(first_model)
# ols_plot_dffits(first_model)
# ols_plot_resid_lev(first_model)

```

Our possible models are the following:

Model 1:
$$
\begin{aligned}\widehat{Y}_{CCPTTH} =& b_{0} + b_{SI} \cdot (x_1) + b_{ESI} \cdot (x_2) + b_{15to65 APP} \cdot (x_3)  + b_{OOPE} \cdot (x_4) + b_{SPM} \cdot (x_5) \\
 = & -393.0875 + 0.9804 \cdot (x_1) + 0.3388 \cdot (x_2) + 7.0896 \cdot (x_3) - 1.0573 \cdot (x_4) \\
 & - 1.1290 \cdot (x_5)
\end{aligned} 
$$



Table 4. ANOVA table for model 1
```{r model1_ANOVA}

anova(first_model)
# summary(first_model)


```

Model 2:
$$
\begin{aligned}\widehat{Y}_{CCPTTH} =& b_{0} + b_{SI} \cdot (x_1) + b_{ESI} \cdot (x_2) + b_{15to65 APP, 1} \cdot (x_3) + b_{15to65 APP, 2} \cdot (x_3^2) \\ & + b_{OOPE} \cdot (x_4) + b_{SPM} \cdot (x_5) \\
 = & 46.5425 + 0.9598 \cdot (x_1) + 0.5042 \cdot (x_2) + 470.5814 \cdot (x_3) + 185.3266 \cdot (x_3^2) \\
 & - 0.9700 \cdot (x_4)  - 0.9366 \cdot (x_5)
\end{aligned} 
$$



Table 5. ANOVA table for model 2
```{r model2_ANOVA}

anova(first_model_1)
# summary(first_model_1)


```

Model 3:
$$
\begin{aligned}\widehat{Y}_{CCPTTH} =& b_{0} + b_{SI} \cdot (x_1) + b_{ESI} \cdot (x_2) + b_{15to65 APP, 1} \cdot (x_3) + b_{15to65 APP, 2} \cdot (x_3^2) + b_{15to65 APP, 3} \cdot (x_3^3) \\ 
& + b_{OOPE} \cdot (x_4) + b_{SPM} \cdot (x_5) \\
 = & 47.7146 + 0.9415 \cdot (x_1) + 0.4975 \cdot (x_2) + 472.4665 \cdot (x_3) + 185.0143 \cdot (x_3^2) + 30.0421 \cdot (x_3^3) \\
&  - 0.9456 \cdot (x_4) - 0.9492 \cdot (x_5)
\end{aligned} 
$$


Table 6. ANOVA table for model 3
```{r model3_ANOVA}

anova(first_model_2)
# summary(first_model_2)

```

Table 7. ANOVA table that compares models 1,2, and 3
```{r model123_ANOVA}

a_tab <- anova(first_model, first_model_1, first_model_2)

a_tab$model <- c(1,2,3)

kable(a_tab,
    digits = 5)


```

Model 4:
$$
\begin{aligned}\widehat{Y}_{CCPTTH} =& b_{0} + b_{SI} \cdot (x_1) + b_{[12.5,25)} \cdot (x_2) + b_{[25,37.5)} \cdot (x_3) \\
& + b_{[37.5,50)} \cdot (x_4) + b_{[50,62.5) } \cdot (x_5) + b_{[62.5, 75) } \cdot (x_6) \\
& + b_{[75,87.5)} \cdot (x_7) + b_{[87.5, 100)} \cdot (x_8) + b_{100} \cdot (x_9) \\
& + b_{15to65 APP} \cdot (x_{10}) + b_{OOPE} \cdot (x_{11}) + b_{SPM} \cdot (x_{12}) \\
 = & - 334.5700 + 1.3656 \cdot (x_1) - 40.8672 \cdot (x_2) - 8.3947 \cdot (x_3) \\
& + 56.3905 \cdot (x_4) - 22.4583 \cdot (x_5) + 30.5148 \cdot (x_6) \\
& - 1.1968 \cdot (x_7) + 62.3486 \cdot (x_8) + 33.4814 \cdot (x_9) \\
& + 5.8760 \cdot (x_{10}) - 0.8848 \cdot (x_{11}) - 1.1878 \cdot (x_{12})
\end{aligned} 
$$

Table 8. ANOVA table for model 4
```{r model4_ANOVA}


anova(first_model_3)
# summary(first_model_3)


```

Model 5:
$$
\begin{aligned}\widehat{Y}_{CCPTTH} =& b_{0} + b_{SI} \cdot (x_1) + b_{[12.5,25)} \cdot (x_2) + b_{[25,37.5)} \cdot (x_3) \\
& + b_{[37.5,50)} \cdot (x_4) + b_{[50,62.5) } \cdot (x_5) + b_{[62.5, 75) } \cdot (x_6) \\
& + b_{[75,87.5)} \cdot (x_7) + b_{[87.5, 100)} \cdot (x_8) + b_{100} \cdot (x_9) \\
& + b_{15to65 APP, 1} \cdot (x_{10}) + b_{15to65 APP, 2} \cdot (x_{10}^2) + b_{OOPE} \cdot (x_{11}) + b_{SPM} \cdot (x_{12}) \\
 = & 23.2830 + 1.3667 \cdot (x_1) - 31.6887 \cdot (x_2) - 5.5304 \cdot (x_3) \\
& + 62.6990 \cdot (x_4) - 14.4446 \cdot (x_5) + 47.0197 \cdot (x_6) \\
& + 15.2648 \cdot (x_7) + 78.2081 \cdot (x_8) + 44.4091 \cdot (x_9) \\
& + 383.6838 \cdot (x_{10}) + 186.2439 \cdot (x_{10}^2) - 0.8132 \cdot (x_{11}) - 0.9564 \cdot (x_{12})
\end{aligned} 
$$


Table 9. ANOVA table for model 5
```{r model5_ANOVA}


# summary(first_model_4)

anova(first_model_4)

```


Table 10. ANOVA table that compares models 1,4 and 5
```{r model45_ANOVA}


a_tab <- anova(first_model, first_model_3, first_model_4)

a_tab$model <- c(1,4,5)

kable(a_tab,
    digits = 5)


```


```{r   model_vifs, fig.cap = "Figure 7.1. VIF values", fig.align = "center"}

car::vif(first_model_1)


```


```{r   SC_SI_fit, fig.cap = "Figure 7.1. Interactive Scatterplot for the cumulative confirmed cases per 10,000 for individual countries against their government response measured by the Stringency Index. The red line is the best fit line. The blue curve is the Loess curve.", fig.align = "center"}

 # p1 <- ggplot(tidy_joined_dataset, aes(x= Stringency_Index, y= cumulative_confirmed_cases_per_10000, size = Population2019, color = Economic_Support_Index, label = Country )) +
 #   geom_point(alpha = 0.4) +
 #   scale_color_gradient(low="#ffff00", high="#ff6600") +
 #   geom_smooth(aes(y = predict(first_model_4), x = Stringency_Index ),se = FALSE, size = 0.4, colour= "purple") +
 #   labs(y = "Cumu. confirmed cases per 10,000", x = "Stringency Index") +
 #   theme(panel.grid.major =  element_line(colour = "#DCDCDC"),
 #         panel.grid.minor = element_line(colour = "#DCDCDC"),
 #         axis.line = element_line(colour = "black"),
 #         panel.background = element_blank(),
 #         panel.border = element_rect(colour = "black",
 #                                     fill=NA,
 #                                     size=0.5))
 # 
 # ggplotly(p1)


```

```{r qqplots ,fig.cap= "Figure 13. Normal Q-Qplot for the model under discussion", fig.align = "center"}

qqnorm(tidy_joined_dataset$cumulative_confirmed_cases_per_10000, pch = 1, frame = TRUE) 
qqline(tidy_joined_dataset$cumulative_confirmed_cases_per_10000, col = "#e6005c", lwd = 2)

```

```{r rez_dis, fig.cap = "Figure 7. Residuals distribution for the statistical model", fig.align = "center"}

# regression_points <- get_regression_points(first_model_1)
# ggplot(regression_points, aes(x = residual)) +
#   geom_histogram(bins = 20, color = "#ff9999", fill = "#e6005c")+
#   labs(x = "Residuals") +
#   theme_bw()

```


```{r rez_fv, fig.cap = "Figure 14. Residuals graph for the fitted values, with a Lowess curve in blue and a horizontal line at zero in red.", fig.align = "center"}

ggplot(tidy_joined_dataset, aes(x = predict(first_model), y = resid(first_model))) +
  geom_point(shape = 1) +
  geom_hline(yintercept = 0,  size = 0.5, colour= "red") +
  geom_smooth(method = "loess", se = TRUE, size = 0.5, colour="blue") +
  labs(y = "Residuals", x = "Fitted Values") +
  theme_bw()

```


```{r rez_SI, fig.cap = "Figure 15. Residuals graph for the Stringency Index, with a Lowess curve in blue and a horizontal line at zero in red.", fig.align = "center"}

rstandard_val <- rstandard(first_model)

ggplot(tidy_joined_dataset, aes(x = Stringency_Index, y = rstandard_val)) +
  geom_point(shape = 1) +
  geom_hline(yintercept = 0,  size = 0.5, colour= "red") +
  geom_smooth(method = "loess", se = TRUE, size = 0.5, colour="blue") +
  labs(y = "rstandard", x = "Stringency Index") +
  theme_bw()

```


```{r rez_ESI, fig.cap = "Figure 16. Residuals graph for the Economic Support Index, with a Lowess curve in blue and a horizontal line at zero in red.", fig.align = "center"} 

ggplot(tidy_joined_dataset, aes(x = Economic_Support_Index, y = rstandard_val)) +
  geom_point(shape = 1) +
  geom_hline(yintercept = 0,  size = 0.5, colour= "red") +
  geom_smooth(method = "loess", se = TRUE, size = 0.5, colour="blue") +
  labs(y = "rstandard", x = "Economic Support Index") +
  theme_bw()

```

```{r rez_APP, fig.cap = "Figure 17. Residuals graph for the Proportion of population that is 15-64 years old, in 2019, with a Lowess curve in blue and a horizontal line at zero in red.", fig.align = "center"}

ggplot(tidy_joined_dataset, aes(x = age15_64_population_prop_2019, y = rstandard_val)) +
  geom_point(shape = 1) +
  geom_hline(yintercept = 0,  size = 0.5, colour= "purple") +
  geom_smooth(method = "loess", se = TRUE, size = 0.5, colour="blue") +
  labs(y = "rstandard", x = "Proportion of population that is 15-64 years old, in 2019") +
  theme_bw()


```


```{r rez_SPM, fig.cap = "Figure 18. Residuals graph for the Smoking prevalence for males in 2016, with a Lowess curve in blue and a horizontal line at zero in red.", fig.align = "center"}

ggplot(tidy_joined_dataset, aes(x = Smoking_prevalence_males_2016, y = rstandard_val)) +
  geom_point(shape = 1) +
  geom_hline(yintercept = 0,  size = 0.5, colour= "purple") +
  geom_smooth(method = "loess", se = TRUE, size = 0.5, colour="blue") +
  labs(y = "rstandard", x = "Smoking prevalence for males in 2016") +
  theme_bw()


```


```{r rez_OPE, fig.cap = "Figure 19. Residuals graph for the Percentage of health expenditures spent out of pocket in 2017, with a Lowess curve in blue and a horizontal line at zero in red.", fig.align = "center"}

ggplot(tidy_joined_dataset, aes(x = out_of_pocket_expenditures_2017, y = rstandard_val)) +
  geom_point(shape = 1) +
  geom_hline(yintercept = 0,  size = 0.5, colour= "purple") +
  geom_smooth(method = "loess", se = TRUE, size = 0.5, colour="blue") +
  labs(y = "rstandard", x = "Percentage of health expenditures spent out of pocket in 2017") +
  theme_bw()


```



## ii. Model Results

***
Table 11. Transformed Model Summary Table ?
```{r   transf_model_summary}
 summary(first_model_1)

```

Table 12. The 95% Confidence Intervals
```{r transf_model_CI}
kable(confint(first_model_1))

```

***

## iii. Interpreting the regression table

Our model is the second model:
Model 2:
$$
\begin{aligned}\widehat{Y}_{CCPTTH} =& b_{0} + b_{SI} \cdot (x_1) + b_{ESI} \cdot (x_2) + b_{15to65 APP, 1} \cdot (x_3) + b_{15to65 APP, 2} \cdot (x_3^2) \\ & + b_{OOPE} \cdot (x_4) + b_{SPM} \cdot (x_5) \\
 = & 46.5425 + 0.9598 \cdot (x_1) + 0.5042 \cdot (x_2) + 470.5814 \cdot (x_3) + 185.3266 \cdot (x_3^2) \\
 & - 0.9700 \cdot (x_4)  - 0.9366 \cdot (x_5)
\end{aligned} 
$$

$$\begin{aligned} H_0:&\beta_{0} = 0 \\\ \mbox{vs }H_A:& \beta_{0} \neq 0 \end{aligned}$$
$$\begin{aligned} H_0:&\beta_{SI} = 0 \\\ \mbox{vs }H_A:& \beta_{SI} \neq 0 \end{aligned}$$
$$\begin{aligned} H_0:&\beta_{ESI} = 0 \\\ \mbox{vs }H_A:& \beta_{ESI} \neq 0 \end{aligned}$$
$$\begin{aligned} H_0:&\beta_{15to65 APP, 1} = 0 \\\ \mbox{vs }H_A:& \beta_{15to65 APP, 1} \neq 0 \end{aligned}$$
$$\begin{aligned} H_0:&\beta_{15to65 APP, 2} = 0 \\\ \mbox{vs }H_A:& \beta_{15to65 APP, 2} \neq 0 \end{aligned}$$
$$\begin{aligned} H_0:&\beta_{OOPE} = 0 \\\ \mbox{vs }H_A:& \beta_{OOPE} \neq 0 \end{aligned}$$
$$\begin{aligned} H_0:&\beta_{SPM} = 0 \\\ \mbox{vs }H_A:& \beta_{SPM} \neq 0 \end{aligned}$$


## iv. Inference for multiple regression



```{r  pred_interv}



# # Get min/max values of SI using the range() function
# SI_lims = filtered %>%
#     select(Stringency_Index) %>%
#     range
# 
# # Generate a sequence of SI values spanning the range
# SI_grid = seq(from = min(SI_lims), to = max(SI_lims)) 
# 
# # Fit a regression spline using basis functions
# first_model_5 = lm(cumulative_confirmed_cases_per_10000 ~  Stringency_Index + ns(Economic_Support_Index, knots = c(25.5,50.5,75.5))  + age15_64_population_prop_2019 + out_of_pocket_expenditures_2017 + Smoking_prevalence_males_2016, data = tidy_joined_dataset)
# 
# # Predict the value of the generated ages,
# # returning the standard error using se = TRUE
# pred = predict(first_model_1, newdata = data.frame(Stringency_Index = SI_grid ,
#                                    Economic_Support_Index = 50,
#                                    age15_64_population_prop_2019 = 65,
#                                    out_of_pocket_expenditures_2017 = 40,
#                                    Smoking_prevalence_males_2016 = 50),
#                interval="prediction",
#                level=.95,
#                se = TRUE)
# 
# 
# 
# 
# #Compute error bands (2*SE)
# se_bands = with(pred, cbind("upper" = fit+2*se.fit,
#                             "lower" = fit-2*se.fit))
# 
# 
# # Plot the spline and error bands
# 
# p_6 <- ggplot() +
#   geom_point(data = tidy_joined_dataset, aes(x = Stringency_Index, y = cumulative_confirmed_cases_per_10000, size = Population2019, color = Economic_Support_Index, label = Country ), alpha = 0.4) +
#   geom_line(aes(x = SI_grid, y = pred$se.fit), color = "purple") +
#   # geom_ribbon(aes(x = SI_grid,
#   #                 ymin = se_bands[,"lower"],
#   #                 ymax = se_bands[,"upper"]),
#   #             alpha = 0.3) +
#   xlim(SI_lims) +
#   scale_color_gradient(low="#ffff00", high="#ff6600") +
#   labs(y = "Cumu. confirmed cases per 10,000", x = "Stringency Index") +
#   theme(panel.grid.major =  element_line(colour = "#DCDCDC"),
#         panel.grid.minor = element_line(colour = "#DCDCDC"),
#         axis.line = element_line(colour = "black"),
#         panel.background = element_blank(),
#         panel.border = element_rect(colour = "black",
#                                     fill=NA,
#                                     size=0.5))
# 
# ggplotly(p_6)


```


Table 13. The 95% Prediction intervals where Stringency Index = 20, 50, 70, 90, respectively, for cumulative confirmed cases per 10,000 = 100, economic support index = 50, population proportion of ages 15 to 64 in 2019 = 65, percentage of out of pocket expenditures 2017 = 30, and Smoking prevalence for males in 2016 = 40
```{r transf_model_PI}

indexes = c(20, 50, 70, 90)

PI <- data.frame(predict(first_model_1, 
              newdata=data.frame(cumulative_confirmed_cases_per_10000 = 100, 
                                 Stringency_Index= indexes, 
                                 Economic_Support_Index = 50,
                                 age15_64_population_prop_2019 = 65,
                                 out_of_pocket_expenditures_2017 = 30,
                                 Smoking_prevalence_males_2016 = 40), 
              interval="prediction", level=.95))
PI$SI <- c(20, 50, 70, 90)
PI <- PI %>%
  dplyr::select(c(SI, fit, lwr, upr))

colnames(PI) <- c("SI" , "Point Estimate" , "Lower Limit" , "Upper Limit")

kable(PI,
    digits = 5)
```




# IV. Discussion 

## i. Conclusions



## ii. Limitations



## iii. Further questions



***


# V. Citations and References {-}
